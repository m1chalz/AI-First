# PetSpot Deployment Guide

Docker-based deployment of PetSpot backend (Node.js/Express) and frontend (React) with nginx reverse proxy.

## Prerequisites

- **Docker** v20.10+ (`docker --version`)
- **docker-compose** v2.0+ (`docker compose version`)
- **Git** (`git --version`)
- **Ports 80/443 free** (not in use by other services)
- **SSH access** configured
- **2GB RAM, 20GB disk space** minimum

## Quick Start

### 1. Clone and Setup

```bash
cd /tmp
git clone <repository-url> petspot
cd petspot
```

### 2. Run Initial Deployment

```bash
cd deployment
./scripts/deploy.sh
```

This script will:
- Verify prerequisites (Docker, docker-compose, Git, ports)
- Create persistent directories (`/var/lib/petspot/db`, `/var/lib/petspot/images`)
- Setup environment configuration from template
- Build backend and frontend Docker images
- Start nginx, backend, and frontend containers
- Verify deployment with health checks

### 3. Verify Deployment

```bash
# Check container status
docker compose ps

# Expected output:
# NAME              STATUS        PORTS
# petspot-nginx     Up (healthy)  0.0.0.0:80->80/tcp
# petspot-backend   Up (healthy)
# petspot-frontend  Up (healthy)
```

### 4. Access Application

- **Frontend**: http://localhost
- **Backend API**: http://localhost/api
- **Images**: http://localhost/images/

## Configuration

### Environment Variables

Edit `.env` after deployment to customize:

```bash
nano deployment/.env
```

Key variables:
- `IMAGE_TAG`: Docker image tag (auto-generated by build.sh)
- `NODE_ENV`: Set to `production` for deployment
- `HOST_DB_PATH`: Database persistence directory
- `HOST_IMAGES_PATH`: Images persistence directory

### Services

Three containers work together:

1. **nginx** (petspot-nginx)
   - Reverse proxy on port 80
   - Routes `/api/*` and `/images/*` to backend
   - Routes other requests to frontend
   - Configuration: `deployment/nginx/nginx.conf`

2. **backend** (petspot-backend)
   - Node.js Express API
   - Internal port 3000 (not exposed to host)
   - Dockerfile: `server/Dockerfile`
   - Volume mounts: SQLite database and images

3. **frontend** (petspot-frontend)
   - React SPA
   - Internal port 8080 (not exposed to host)
   - Dockerfile: `webApp/Dockerfile`
   - Multi-stage build: Node.js build + nginx serving

## Data Persistence

SQLite database and uploaded images persist across container recreation:

```
/var/lib/petspot/
├── db/
│   └── pets.db              (mounted to container)
└── images/
    └── <uploaded files>     (mounted to container)
```

## Docker Images

Images are tagged with commit hash and timestamp for traceability:

```bash
# Built as: petspot-backend:a1b2c3d-20251128-143022
# Also tagged as: petspot-backend:latest

docker images
```

## Common Operations

### View Logs

```bash
# All services
docker compose logs -f

# Specific service
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f nginx
```

### Stop All Containers

```bash
docker compose down
```

### Start All Containers

```bash
docker compose up -d
```

### Restart Single Service

```bash
docker compose restart backend
docker compose restart frontend
```

### Remove All Data (WARNING: destroys database)

```bash
docker compose down -v
```

## Troubleshooting

### Port 80 Already in Use

```bash
# Find what's using port 80
sudo netstat -tuln | grep ':80'

# Stop conflicting service
sudo systemctl stop apache2
```

### Container Won't Start

```bash
# Check logs
docker compose logs backend

# Rebuild without cache
docker compose build --no-cache
```

### Database Access Issues

```bash
# Fix permissions
sudo chown -R $USER:$USER /var/lib/petspot/db
chmod 644 /var/lib/petspot/db/pets.db
```

### Images Not Serving

```bash
# Check directory permissions
sudo chown -R $USER:$USER /var/lib/petspot/images
chmod -R 755 /var/lib/petspot/images
```

### Containers Keep Restarting

```bash
# Check status
docker compose ps

# View recent logs
docker compose logs --tail=50 backend
```

## Health Checks

Docker Compose automatically monitors container health:

```bash
# View health status
docker compose ps

# Manual verification
curl http://localhost                              # Frontend
curl http://localhost/api/v1/announcements         # Backend
curl http://localhost/health                       # Nginx
```

## Updating Applications

All data (database and images) persists across updates.

### Update Backend Only

```bash
cd deployment
./scripts/update.sh --backend
```

This will:
- Pull latest code from Git
- Rebuild backend image
- Recreate backend container
- Verify backend health

### Update Frontend Only

```bash
cd deployment
./scripts/update.sh --frontend
```

This will:
- Pull latest code from Git
- Rebuild frontend image
- Recreate frontend container
- Verify frontend health

### Update All Services

```bash
cd deployment
./scripts/update.sh --all
```

This will:
- Pull latest code from Git
- Rebuild all images
- Recreate all containers
- Verify all services

### Verification

After update, verify data persistence:

```bash
# Database: Check data is intact
docker exec petspot-backend sqlite3 /app/server/db/pets.db "SELECT COUNT(*) FROM announcements;"

# Images: Check files exist
docker exec petspot-backend ls -la /app/server/public/images/
```

### Downtime During Updates

- Backend update: Frontend continues serving (nginx cached)
- Frontend update: Backend continues running (API unaffected)
- Full update: All services down during rebuild (~5-10 minutes)

## Networking

Containers communicate via Docker bridge network (`petspot-network`):

- nginx can reach backend at `http://backend:3000`
- nginx can reach frontend at `http://frontend:8080`
- Frontend and backend isolated from host network

External access only through nginx on port 80.

## Deployment Structure

```
deployment/
├── docker-compose.yml          Container orchestration
├── nginx/
│   └── nginx.conf              Reverse proxy configuration
├── scripts/
│   ├── build.sh                Build Docker images
│   ├── deploy.sh               Initial deployment
│   ├── update.sh               Update applications
│   └── logs.sh                 View container logs
├── envExample                  Environment template
└── README.md                   This file
```

## Future Enhancements

- [ ] HTTPS/SSL with Let's Encrypt
- [ ] Automated backups for `/var/lib/petspot/`
- [ ] Monitoring and alerting
- [ ] CI/CD pipeline for automated deployments
- [ ] Multi-instance deployment (Swarm/Kubernetes)

## Support

For issues:
1. Check logs: `docker compose logs -f`
2. Verify prerequisites are met
3. Review troubleshooting section above
4. Check firewall rules (port 80 must be open)

