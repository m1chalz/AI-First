# Data Model: Create Announcement Endpoint

**Feature**: POST `/api/v1/announcements` endpoint  
**Generated**: 2025-11-24  
**Status**: Complete

## Domain Entities

### Announcement

Represents a pet announcement (lost or found pet listing) with contact information and location details.

**State Lifecycle**: Single state (persisted immediately upon creation, no workflow states)

**Persistence**: `announcement` table in SQLite database (designed for PostgreSQL migration)

---

## Database Schema

### Table: `announcement`

```sql
CREATE TABLE IF NOT EXISTS announcement (
  -- Primary Key
  id TEXT PRIMARY KEY,                    -- UUID v4 (generated by application)
  
  -- Pet Information
  pet_name TEXT,                          -- Optional: Pet's name
  species TEXT NOT NULL,                  -- Required: Pet species (e.g., "Golden Retriever", "Persian Cat")
  breed TEXT,                             -- Optional: Pet breed
  sex TEXT NOT NULL,                      -- Required: Pet sex (no length limit per spec)
  age INTEGER,                            -- Optional: Pet age in years (positive integer, app-validated)
  description TEXT,                       -- Optional: Free-text description
  microchip_number TEXT UNIQUE,           -- Optional: Microchip identifier (numeric only, app-validated, unique across all announcements)
  
  -- Location Information
  location_city TEXT,                     -- Optional: City name
  location_latitude REAL NOT NULL,        -- Required: Latitude (-90 to 90, app-validated)
  location_longitude REAL NOT NULL,       -- Required: Longitude (-180 to 180, app-validated)
  location_radius INTEGER,                -- Optional: Search radius in kilometers
  
  -- Contact Information (at least one required)
  email TEXT,                             -- Optional: Contact email (RFC 5322 format, app-validated)
  phone TEXT,                             -- Optional: Contact phone (E.164 format recommended, app-validated)
  
  -- Additional Information
  photo_url TEXT NOT NULL,                -- Required: URL to pet photo (http/https only, app-validated)
  last_seen_date TEXT NOT NULL,           -- Required: ISO 8601 date (YYYY-MM-DD, must be today or past, app-validated)
  status TEXT NOT NULL,                   -- Required: Announcement status (MISSING or FOUND, app-validated)
  reward TEXT,                            -- Optional: Reward information
  
  -- Security
  management_password_hash TEXT NOT NULL, -- Required: Hashed 6-digit password (bcrypt, never exposed in GET responses)
  
  -- Timestamps
  created_at TEXT NOT NULL DEFAULT (datetime('now')) -- Announcement creation timestamp (ISO 8601)
);
```

**Schema Notes**:
1. **All text fields use TEXT type** (no length constraints as per spec)
2. **No database-level enums** (store as TEXT, validate in application layer for SQLite → PostgreSQL portability)
3. **No CHECK constraints** (all validation in application layer per constitution)
4. **UNIQUE constraint on microchip_number** (prevents duplicate announcements for same pet)
5. **Singular table name** (`announcement`, not `announcements`) per constitution
6. **Idempotent schema** (uses `IF NOT EXISTS` for migrations)
7. **No indexes** (performance optimization skipped for MVP simplicity)

---

## Field Specifications

### Required Fields (HTTP 400 if missing)

| Field | Type | Constraints | Error Code |
|-------|------|-------------|------------|
| `species` | string | Non-empty, non-whitespace | `MISSING_VALUE` |
| `sex` | string | Non-empty, non-whitespace | `MISSING_VALUE` |
| `lastSeenDate` | string | ISO 8601 date, not future | `MISSING_VALUE`, `INVALID_FORMAT` |
| `photoUrl` | string | Valid URL with http/https | `MISSING_VALUE`, `INVALID_FORMAT` |
| `status` | string | "MISSING" or "FOUND" only | `MISSING_VALUE`, `INVALID_FORMAT` |
| `locationLatitude` | number | Decimal, -90 to 90 | `MISSING_VALUE`, `INVALID_FORMAT` |
| `locationLongitude` | number | Decimal, -180 to 180 | `MISSING_VALUE`, `INVALID_FORMAT` |
| `email` OR `phone` | string | At least one contact required | `MISSING_CONTACT` |

### Optional Fields (can be omitted or null)

| Field | Type | Constraints | Error Code (if provided but invalid) |
|-------|------|-------------|-------------------------------------|
| `petName` | string | Any length, sanitized | N/A |
| `breed` | string | Any length, sanitized | N/A |
| `age` | integer | Positive integer (> 0) | `INVALID_FORMAT` |
| `description` | string | Any length, sanitized | N/A |
| `microchipNumber` | string | Numeric only, unique | `INVALID_FORMAT`, `CONFLICT` |
| `locationCity` | string | Any length, sanitized | N/A |
| `locationRadius` | integer | Any positive integer | N/A |
| `email` | string | RFC 5322 format | `INVALID_FORMAT` |
| `phone` | string | E.164 format (recommended) | `INVALID_FORMAT` |
| `reward` | string | Any length, sanitized | N/A |

### System-Generated Fields (NOT accepted in request body)

| Field | Type | Description |
|-------|------|-------------|
| `id` | string | UUID v4 generated by application |
| `managementPassword` | string | 6-digit numeric password (returned only once in POST response) |
| `managementPasswordHash` | string | bcrypt hash stored in database |
| `createdAt` | string | ISO 8601 timestamp (generated by database) |

---

## Validation Rules

### 1. Unknown Field Rejection (Fail-Fast, Priority 1)

**Rule**: Reject requests containing fields not in allowed list  
**Error Code**: `INVALID_FIELD`  
**HTTP Status**: 400  
**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FIELD",
    "message": "unknownFieldName is not a valid field",
    "field": "unknownFieldName"
  }
}
```

**Allowed Fields**:
```typescript
[
  'petName', 'species', 'breed', 'sex', 'age',
  'description', 'microchipNumber', 'locationCity',
  'locationLatitude', 'locationLongitude', 'locationRadius',
  'lastSeenDate', 'email', 'phone', 'photoUrl',
  'status', 'reward'
]
```

**Implementation Note**: Check for unknown fields BEFORE any other validation (security measure).

---

### 2. Required Field Presence (Priority 2)

**Rule**: All required fields must be present and non-empty  
**Error Code**: `MISSING_VALUE`  
**HTTP Status**: 400  

**Required Fields**:
- `species`
- `sex`
- `lastSeenDate`
- `photoUrl`
- `status`
- `locationLatitude`
- `locationLongitude`
- At least one of: `email` OR `phone` (see Contact Validation)

**Whitespace Handling**: Trim all string fields. Reject if result is empty string.

---

### 3. Contact Method Validation (Priority 3)

**Rule**: At least one contact method (email OR phone OR both) must be provided  
**Error Code**: `MISSING_CONTACT`  
**HTTP Status**: 400  
**Error Format**:
```json
{
  "error": {
    "code": "MISSING_CONTACT",
    "message": "at least one contact method (email or phone) is required",
    "field": "contact"
  }
}
```

**Valid Scenarios**:
- ✅ Email only
- ✅ Phone only
- ✅ Both email and phone
- ❌ Neither email nor phone (reject)

---

### 4. Format Validation (Priority 4)

#### Email Format

**Rule**: If provided, email must match RFC 5322 basic format  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  
**Validator**: Use existing `/server/src/lib/validators.ts` → `validateEmail()`

**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "invalid email format",
    "field": "email"
  }
}
```

#### Phone Format

**Rule**: If provided, phone must match expected format (E.164 recommended)  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  
**Validator**: Use existing `/server/src/lib/validators.ts` → `validatePhone()`

**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "invalid phone format",
    "field": "phone"
  }
}
```

#### Microchip Number Format

**Rule**: If provided, microchip number must contain only digits (0-9)  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  
**Regex**: `/^\d+$/`

**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "must contain only digits",
    "field": "microchipNumber"
  }
}
```

#### Age Format

**Rule**: If provided, age must be a positive integer (> 0)  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  
**Validation**: `Number.isInteger(age) && age > 0`

**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "age must be a positive integer",
    "field": "age"
  }
}
```

#### Status Format

**Rule**: Status must be exactly "MISSING" or "FOUND" (case-sensitive)  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  

**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "status must be either MISSING or FOUND",
    "field": "status"
  }
}
```

#### Photo URL Format

**Rule**: photoUrl must be a valid URL with http or https protocol  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  
**Validator**: Node.js `URL` constructor + protocol check

**Error Format**:
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "must be a valid URL with http or https protocol",
    "field": "photoUrl"
  }
}
```

**Implementation**:
```typescript
try {
  const url = new URL(photoUrl);
  if (url.protocol !== 'http:' && url.protocol !== 'https:') {
    throw new ValidationError('INVALID_FORMAT', 'must be a valid URL with http or https protocol', 'photoUrl');
  }
} catch {
  throw new ValidationError('INVALID_FORMAT', 'must be a valid URL with http or https protocol', 'photoUrl');
}
```

#### Last Seen Date Format

**Rule**: lastSeenDate must be ISO 8601 date (YYYY-MM-DD) and not a future date  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  

**Validation Steps**:
1. Check ISO 8601 format (YYYY-MM-DD)
2. Check date is today or in the past

**Error Format** (future date):
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "lastSeenDate cannot be in the future",
    "field": "lastSeenDate"
  }
}
```

**Implementation**:
```typescript
const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
if (!dateRegex.test(lastSeenDate)) {
  throw new ValidationError('INVALID_FORMAT', 'invalid date format (expected YYYY-MM-DD)', 'lastSeenDate');
}

const date = new Date(lastSeenDate);
const today = new Date();
today.setHours(0, 0, 0, 0); // Reset time for comparison

if (date > today) {
  throw new ValidationError('INVALID_FORMAT', 'lastSeenDate cannot be in the future', 'lastSeenDate');
}
```

---

### 5. Range Validation (Priority 5)

#### Location Latitude

**Rule**: Latitude must be a valid decimal number between -90 and 90  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  

**Error Format** (non-numeric):
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "must be a valid decimal number",
    "field": "locationLatitude"
  }
}
```

**Error Format** (out of range):
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "latitude must be between -90 and 90",
    "field": "locationLatitude"
  }
}
```

#### Location Longitude

**Rule**: Longitude must be a valid decimal number between -180 and 180  
**Error Code**: `INVALID_FORMAT`  
**HTTP Status**: 400  

**Error Format** (non-numeric):
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "must be a valid decimal number",
    "field": "locationLongitude"
  }
}
```

**Error Format** (out of range):
```json
{
  "error": {
    "code": "INVALID_FORMAT",
    "message": "longitude must be between -180 and 180",
    "field": "locationLongitude"
  }
}
```

---

### 6. Text Sanitization (XSS Prevention)

**Rule**: All text fields must be sanitized to strip HTML tags  
**Implementation**: Use `sanitize-html` with `allowedTags: []`  
**Applied To**: All string fields EXCEPT email, phone, photoUrl (URLs/contacts need special handling)

**Fields Sanitized**:
- `petName`
- `species`
- `breed`
- `sex`
- `description`
- `locationCity`
- `reward`

**Example**:
```typescript
import sanitizeHtml from 'sanitize-html';

const sanitized = sanitizeHtml(input, {
  allowedTags: [],
  allowedAttributes: {},
  disallowedTagsMode: 'discard'
});

// Input:  "<script>alert('xss')</script>Hello"
// Output: "Hello"
```

---

### 7. Uniqueness Validation (Priority 6)

#### Microchip Number Uniqueness

**Rule**: If microchipNumber is provided, it must be unique across all announcements  
**Error Code**: `CONFLICT`  
**HTTP Status**: 409  

**Error Format**:
```json
{
  "error": {
    "code": "CONFLICT",
    "message": "An entity with this value already exists",
    "field": "microchipNumber"
  }
}
```

**Implementation**:
```typescript
const existing = await db('announcement')
  .where('microchip_number', microchipNumber)
  .first();

if (existing) {
  throw new ConflictError('An entity with this value already exists', 'microchipNumber');
}
```

**Note**: Uniqueness check happens AFTER all format validation (fail-fast on format first, then database check).

---

### 8. Payload Size Validation

**Rule**: Request body must not exceed 10 MB  
**Error Code**: `PAYLOAD_TOO_LARGE`  
**HTTP Status**: 413  
**Implementation**: Express middleware `express.json({ limit: '10mb' })`

**Error Format**:
```json
{
  "error": {
    "code": "PAYLOAD_TOO_LARGE",
    "message": "Request payload exceeds maximum size limit"
  }
}
```

---

## Validation Order (Fail-Fast)

System validates in this exact order and returns the FIRST error encountered:

1. ✅ **Payload size** (10 MB limit) - HTTP 413
2. ✅ **Unknown fields** (strict field whitelist) - HTTP 400
3. ✅ **Required field presence** (non-empty check) - HTTP 400
4. ✅ **Contact method presence** (email OR phone) - HTTP 400
5. ✅ **Format validation** (email, phone, URL, date, numeric, etc.) - HTTP 400
6. ✅ **Range validation** (coordinates, age > 0) - HTTP 400
7. ✅ **Duplicate check** (microchip uniqueness) - HTTP 409
8. ✅ **Text sanitization** (XSS prevention, applied before storage)
9. ✅ **Password generation** (6-digit numeric)
10. ✅ **Password hashing** (bcrypt)
11. ✅ **Database insert** (announcement persisted)

**Error Response**: Only the first error is returned (no batch validation).

---

## Domain Model (TypeScript)

### Request DTO

```typescript
/**
 * Data Transfer Object for creating a new announcement.
 * Represents the request body for POST /api/v1/announcements
 */
export interface CreateAnnouncementDto {
  // Pet Information
  petName?: string;                  // Optional
  species: string;                   // Required
  breed?: string;                    // Optional
  sex: string;                       // Required
  age?: number;                      // Optional (positive integer)
  description?: string;              // Optional
  microchipNumber?: string;          // Optional (numeric only, unique)
  
  // Location Information
  locationCity?: string;             // Optional
  locationLatitude: number;          // Required (decimal, -90 to 90)
  locationLongitude: number;         // Required (decimal, -180 to 180)
  locationRadius?: number;           // Optional (kilometers)
  
  // Contact Information (at least one required)
  email?: string;                    // Optional (but email OR phone required)
  phone?: string;                    // Optional (but email OR phone required)
  
  // Additional Information
  photoUrl: string;                  // Required (URL with http/https)
  lastSeenDate: string;              // Required (ISO 8601 date, not future)
  status: 'MISSING' | 'FOUND';       // Required
  reward?: string;                   // Optional
}
```

### Response DTO

```typescript
/**
 * Announcement entity returned by the API.
 * Extends CreateAnnouncementDto with system-generated fields.
 */
export interface AnnouncementDto extends CreateAnnouncementDto {
  id: string;                        // UUID v4 (system-generated)
  createdAt: string;                 // ISO 8601 timestamp (system-generated)
  managementPassword?: string;       // 6-digit password (ONLY in POST response, never in GET)
}
```

### Database Entity

```typescript
/**
 * Announcement database entity.
 * Maps to 'announcement' table with snake_case column names.
 */
export interface AnnouncementEntity {
  // Primary Key
  id: string;                        // UUID v4
  
  // Pet Information
  pet_name: string | null;
  species: string;
  breed: string | null;
  sex: string;
  age: number | null;
  description: string | null;
  microchip_number: string | null;
  
  // Location Information
  location_city: string | null;
  location_latitude: number;
  location_longitude: number;
  location_radius: number | null;
  
  // Contact Information
  email: string | null;
  phone: string | null;
  
  // Additional Information
  photo_url: string;
  last_seen_date: string;            // ISO 8601 date
  status: string;                    // 'MISSING' or 'FOUND'
  reward: string | null;
  
  // Security
  management_password_hash: string;  // bcrypt hash
  
  // Timestamps
  created_at: string;                // ISO 8601 timestamp
}
```

---

## State Transitions

**Initial State**: N/A (announcements are created directly in active state)

**Created Announcement**:
- Status: `MISSING` or `FOUND` (user-provided in request)
- No workflow states or transitions in this feature

**Management Operations**: Out of scope for this feature (password generated but not used yet)

---

## Database Migrations

### Migration File: `YYYYMMDDHHMMSS_create-announcement-table.ts`

```typescript
import { Knex } from 'knex';

export async function up(knex: Knex): Promise<void> {
  await knex.schema.createTable('announcement', (table) => {
    // Primary Key
    table.text('id').primary();
    
    // Pet Information
    table.text('pet_name').nullable();
    table.text('species').notNullable();
    table.text('breed').nullable();
    table.text('sex').notNullable();
    table.integer('age').nullable();
    table.text('description').nullable();
    table.text('microchip_number').nullable().unique();
    
    // Location Information
    table.text('location_city').nullable();
    table.real('location_latitude').notNullable();
    table.real('location_longitude').notNullable();
    table.integer('location_radius').nullable();
    
    // Contact Information
    table.text('email').nullable();
    table.text('phone').nullable();
    
    // Additional Information
    table.text('photo_url').notNullable();
    table.text('last_seen_date').notNullable();
    table.text('status').notNullable();
    table.text('reward').nullable();
    
    // Security
    table.text('management_password_hash').notNullable();
    
    // Timestamps
    table.text('created_at').notNullable().defaultTo(knex.raw("(datetime('now'))"));
  });
}

export async function down(knex: Knex): Promise<void> {
  await knex.schema.dropTableIfExists('announcement');
}
```

**Migration Command**:
```bash
cd server
npm run knex:add-migration create-announcement-table
```

---

## Logging & Privacy

### PII Redaction Rules

**Implementation**: Custom utility in `/server/src/lib/pii-redaction.ts`

**Redacted Fields**:
- **Phone**: Show only last 3 digits (e.g., `"+1-555-123-4567"` → `"***-***-*567"`)
- **Email**: Show only first letter and domain (e.g., `"john@example.com"` → `"j***@example.com"`)

**Log Format** (example):
```typescript
{
  timestamp: '2025-11-24T12:34:56.789Z',
  announcementId: '550e8400-e29b-41d4-a716-446655440000',
  status: 201,
  email: 'j***@example.com',        // Redacted
  phone: '***-***-*567',             // Redacted
  species: 'Golden Retriever',
  validationError: null
}
```

**Not Logged**:
- Full PII (email, phone in plain text)
- Pet descriptions (privacy concern)
- Management password (security concern)
- Password hashes (security concern)

---

## Security Considerations

1. **XSS Prevention**: All text fields sanitized (strip HTML tags)
2. **Password Security**: Management password hashed with bcrypt (never stored plain)
3. **PII Protection**: Contact information redacted in logs
4. **SQL Injection**: Knex query builder prevents SQL injection (parameterized queries)
5. **Unknown Field Rejection**: Strict field validation prevents injection attacks
6. **Payload Size Limit**: 10 MB limit prevents DoS attacks
7. **Rate Limiting**: Deferred to infrastructure layer (out of scope)

---

## Performance Considerations

**Note**: Performance optimizations are intentionally skipped for MVP simplicity.

1. **No indexes** (queries will perform full table scans - acceptable for low-traffic MVP)
2. **Fail-Fast Validation**: Stop at first error (minimize processing time)
3. **Text Sanitization**: Applied before storage (not on every read)
4. **Password Hashing**: scrypt with default parameters (acceptable for user-facing operations)

---

## Next Steps

- ✅ Generate OpenAPI contract (`/contracts/openapi.yaml`)
- ✅ Generate implementation quickstart (`quickstart.md`)
- ✅ Update agent context with new technologies
- ⏳ Generate task breakdown (`/speckit.tasks` command)

