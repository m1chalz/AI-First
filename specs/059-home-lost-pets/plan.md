# Implementation Plan: Home Lost Pets Teaser

**Branch**: `059-home-lost-pets` | **Date**: 2025-12-16 | **Spec**: [spec.md](../spec.md)
**Input**: Feature specification from `/specs/059-home-lost-pets/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command following Phase 0 research and Phase 1 design. Ready for Phase 2 task breakdown.

## Summary

Implement a lost pets teaser as an **autonomous, reusable feature** on the Android home page that displays up to 5 recently reported lost pets. The teaser is self-contained with its own ViewModel and MVI architecture, enabling reuse in other screens. It reuses the existing `Animal` domain model and `AnimalRepository` with client-side filtering. Home page is implemented as a `LazyColumn` for scrollability.

## Technical Context

**Language/Version**: Kotlin 2.2.20 (Android target)
**Primary Dependencies**: Jetpack Compose, Koin (DI), Kotlin Coroutines + Flow, Ktor (HTTP client), Jetpack Navigation Component  
**Storage**: N/A (data fetched from backend API)  
**Testing**: JUnit 6 + Kotlin Test + Turbine (Flow testing)  
**Target Platform**: Android API 26+ (Android 8.0+) with target SDK 36  
**Project Type**: Mobile (Android only)  
**Performance Goals**: N/A (Performance is not a concern for this project - see Principle XIV)  
**Constraints**: Must follow MVI architecture, reuse existing navigation patterns, integrate with existing lost pets list  
**Scale/Scope**: Small feature (1 new component), low complexity, expected ~5-10 files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

> **Note**: For backend-only features (affecting only `/server` module), you may mark frontend-related checks (Platform Independence, Android MVI, iOS MVVM-C, Test Identifiers for UI, E2E Tests for mobile/web) as N/A. Focus on Backend Architecture & Quality Standards checks.

### Platform Architecture Compliance

- [x] **Platform Independence**: Each platform implements full stack independently
  - Android: Domain models, use cases, repositories, ViewModels in `/composeApp`
  - iOS: Domain models, use cases, repositories, ViewModels in `/iosApp`
  - Web: Domain models, services, state management in `/webApp`
  - Backend: Independent Node.js/Express API in `/server`
  - NO shared compiled code between platforms
  - Violation justification: _Android-only feature - justified as this component is specific to Android home page_

- [x] **Android MVI Architecture**: Android features follow the mandated Compose MVI loop
  - Single `StateFlow<UiState>` source of truth with immutable data classes
  - Sealed `UserIntent` and optional `UiEffect` types co-located with feature packages
  - Reducers implemented as pure functions (no side effects) and unit-tested
  - `dispatchIntent` entry wired from UI → ViewModel → reducer, with effects delivered via `SharedFlow`
  - Navigation MUST use Jetpack Navigation Component (androidx.navigation:navigation-compose)
  - Navigation graph defined with `NavHost` composable
  - ViewModels trigger navigation via `UiEffect`, not direct `NavController` calls
  - Composable screens follow two-layer pattern: state host (stateful) + stateless content composable
  - Stateless composables MUST have `@Preview` with `@PreviewParameter` using custom `PreviewParameterProvider<UiState>`
  - Callback lambdas MUST be defaulted to no-ops in stateless composables
  - Previews focus on light mode only (no dark mode previews required)

- [ ] **iOS MVVM-C Architecture**: iOS features follow MVVM-Coordinator pattern
  - N/A - Android-only feature

- [x] **Interface-Based Design**: Domain logic uses interfaces for repositories (per platform)
  - Android: Repository interfaces in `/composeApp/src/androidMain/.../domain/repositories/`
  - Implementations in platform-specific data/repositories modules
  - Use cases reference interfaces, not concrete implementations

- [x] **Dependency Injection**: Plan includes DI setup for each platform
  - Android: MUST use Koin - DI modules in `/composeApp/src/androidMain/.../di/`

- [x] **80% Test Coverage - Platform-Specific**: Plan includes unit tests for each platform
  - Android: Tests in `/composeApp/src/androidUnitTest/`, run `./gradlew :composeApp:testDebugUnitTest koverHtmlReport`
  - Coverage target: 80% line + branch coverage per platform

- [x] **End-to-End Tests**: Plan includes E2E tests for all user stories
  - Mobile: Java 21 + Maven + Appium + Cucumber in `/e2e-tests/java/`
  - Features in `/e2e-tests/java/src/test/resources/features/mobile/` (shared iOS/Android)
  - Screen Object Model in `/e2e-tests/java/src/test/java/.../screens/`
  - Step definitions in `/e2e-tests/java/src/test/java/.../steps/mobile/`
  - Each user story has at least one E2E test

- [x] **Asynchronous Programming Standards**: Plan uses correct async patterns per platform
  - Android: Kotlin Coroutines (`viewModelScope`) + Flow for state
  - No Combine, RxJava, RxSwift, or callback-based patterns for new code

- [x] **Test Identifiers for UI Controls**: Plan includes test identifiers for all interactive elements
  - Android: `testTag` modifier on all interactive composables
  - Naming convention: `{screen}.{element}.{action}` (e.g., `petList.addButton.click`)
  - List items use stable IDs (e.g., `petList.item.${id}`)

- [x] **Public API Documentation**: Plan ensures public APIs have documentation when needed
  - Kotlin: KDoc format (`/** ... */`)
  - Documentation must be concise and high-level (1-3 sentences: WHAT/WHY, not HOW)
  - Document only when purpose is not clear from name alone

- [x] **Given-When-Then Test Structure**: Plan ensures all tests follow Given-When-Then convention
  - Unit tests clearly separate setup (Given), action (When), verification (Then)
  - ViewModel tests use Given-When-Then pattern with descriptive names
  - E2E tests structure scenarios with Given-When-Then phases
  - Test names follow platform conventions (backticks for Kotlin)

### Backend Architecture & Quality Standards (if `/server` affected)

- [ ] **Backend Technology Stack**: Plan uses modern Node.js stack for `/server` module
  - N/A - Android-only feature, no backend changes required

- [ ] **Backend Code Quality**: Plan enforces quality standards for `/server` code
  - N/A - Android-only feature, no backend changes required

- [ ] **Backend Dependency Management**: Plan minimizes dependencies in `/server/package.json`
  - N/A - Android-only feature, no backend changes required

### Web Architecture & Quality Standards (if `/webApp` affected)

- [ ] **Web Technology Stack**: Plan uses modern React 18 + TypeScript stack for `/webApp` module
  - N/A - Android-only feature, no web changes required

- [ ] **Web Code Quality**: Plan enforces quality standards for `/webApp` code
  - N/A - Android-only feature, no web changes required

- [ ] **Web Dependency Management**: Plan minimizes dependencies in `/webApp/package.json`
  - N/A - Android-only feature, no web changes required

- [ ] **Web Business Logic Extraction**: Plan ensures business logic is extracted to testable functions
  - N/A - Android-only feature, no web changes required

- [ ] **Web TDD Workflow**: Plan follows Test-Driven Development (Red-Green-Refactor)
  - N/A - Android-only feature, no web changes required

- [ ] **Web Testing Strategy**: Plan includes comprehensive test coverage for `/webApp`
  - N/A - Android-only feature, no web changes required

- [ ] **Backend Directory Structure**: Plan follows standardized layout in `/server/src/`
  - N/A - Android-only feature, no backend changes required

- [ ] **Backend TDD Workflow**: Plan follows Test-Driven Development (Red-Green-Refactor)
  - N/A - Android-only feature, no backend changes required

- [ ] **Backend Testing Strategy**: Plan includes comprehensive test coverage for `/server`
  - N/A - Android-only feature, no backend changes required

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

```text
composeApp/src/androidMain/kotlin/com/intive/aifirst/petspot/
├── features/
│   ├── home/
│   │   └── ui/
│   │       └── HomeScreen.kt                 # Main home screen (LazyColumn container)
│   └── lostPetsTeaser/
│       ├── presentation/
│       │   ├── mvi/
│       │   │   ├── LostPetsTeaserUiState.kt  # Data class with isLoading, error, animals
│       │   │   ├── LostPetsTeaserIntent.kt   # Sealed interface for user actions
│       │   │   ├── LostPetsTeaserEffect.kt   # Sealed class for navigation effects
│       │   │   └── LostPetsTeaserReducer.kt  # Pure reducer functions
│       │   └── viewmodels/
│       │       └── LostPetsTeaserViewModel.kt # Autonomous ViewModel for teaser
│       └── ui/
│           ├── LostPetsTeaser.kt             # Stateful teaser (gets own ViewModel)
│           └── LostPetsTeaserContent.kt      # Stateless content with @Preview
├── composeapp/domain/
│   ├── models/
│   │   └── Animal.kt                         # EXISTING - reused, no changes
│   ├── repositories/
│   │   └── AnimalRepository.kt               # EXISTING - reused, no changes
│   └── usecases/
│       ├── GetAnimalsUseCase.kt              # EXISTING - reused by new use case
│       └── GetRecentAnimalsUseCase.kt        # NEW - filters MISSING, sorts, limits 5
├── di/
│   ├── DomainModule.kt                       # EXISTING - add GetRecentAnimalsUseCase
│   └── ViewModelModule.kt                    # EXISTING - add LostPetsTeaserViewModel
└── ui/navigation/
    └── MainScaffold.kt                       # EXISTING - update HomeRoute.Root composable

composeApp/src/androidUnitTest/kotlin/com/intive/aifirst/petspot/
├── features/lostPetsTeaser/presentation/
│   ├── viewmodels/
│   │   └── LostPetsTeaserViewModelTest.kt    # ViewModel unit tests
│   └── mvi/
│       └── LostPetsTeaserReducerTest.kt      # Reducer unit tests
└── composeapp/domain/usecases/
    └── GetRecentAnimalsUseCaseTest.kt        # Use case unit tests

e2e-tests/java/src/test/
├── resources/features/mobile/
│   └── home_lost_pets_teaser.feature         # Gherkin scenarios (shared iOS/Android)
└── java/com/intive/petspot/
    ├── screens/
    │   └── LostPetsTeaserScreen.java         # Screen Object Model for teaser
    └── steps/mobile/
        └── HomeLostPetsTeaserSteps.java      # Step definitions
```

**Structure Decision**: 
- **Autonomous teaser feature**: `features/lostPetsTeaser/` is self-contained with its own ViewModel and MVI classes. Can be embedded in any screen via `LostPetsTeaser()` composable.
- **Reuse existing domain**: Uses existing `Animal` model and `AnimalRepository`. New `GetRecentAnimalsUseCase` handles client-side filtering (MISSING status), sorting (newest first), and limiting (5 items).
- **Existing DI modules**: ViewModel added to `ViewModelModule.kt`, use case to `DomainModule.kt`. No new module files.
- **Home as container**: `HomeScreen.kt` is a simple `LazyColumn` that composes the teaser and future components.
- **E2E tests**: Follow constitution pattern with shared mobile features in `features/mobile/`.

## Key Implementation Notes

### Test Identifiers (Constitution-compliant)

```kotlin
// Teaser container
Modifier.testTag("lostPetsTeaser.container")

// Loading state
Modifier.testTag("lostPetsTeaser.loading")

// Error state
Modifier.testTag("lostPetsTeaser.error")
Modifier.testTag("lostPetsTeaser.retryButton")

// Empty state
Modifier.testTag("lostPetsTeaser.emptyState")

// Pet cards (reuses AnimalCard styling)
Modifier.testTag("lostPetsTeaser.petCard.${petId}")

// View All button
Modifier.testTag("lostPetsTeaser.viewAllButton")
```

### Navigation Strategy

Navigation from teaser uses **effect abstraction** for future deep link support:

```kotlin
// Teaser emits navigation effects (WHAT to do)
sealed class LostPetsTeaserEffect {
    data class NavigateToPetDetails(val petId: String) : LostPetsTeaserEffect()
    object NavigateToLostPetsList : LostPetsTeaserEffect()
}

// HomeScreen handles effects (HOW to do it)
// Current: Tab switch + navigate within LostPet tab
// Future: Could use deep links without changing teaser
```

**Navigation behavior**: When user navigates to pet details from teaser:
1. App switches to Lost Pet tab
2. Pet details screen opens within that tab
3. Back navigation returns to Lost Pet list (not Home tab)

This matches iOS behavior (spec 058) for cross-platform consistency.

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | N/A |
