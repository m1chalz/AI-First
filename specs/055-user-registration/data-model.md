# Data Model: User Registration

**Feature**: 055-user-registration  
**Date**: December 15, 2025

## Overview

This document defines the data model for user registration. The feature introduces a single entity (`User`) with validation rules extracted from functional requirements in the specification.

## Entities

### User

Represents a registered user account in the system.

**Purpose**: Store user credentials and metadata for authentication purposes (authentication implementation is out of scope for this feature).

**Storage**: Database table `user` in SQLite (development) / PostgreSQL (production)

#### Fields

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| `id` | UUID (stored as TEXT) | PRIMARY KEY, NOT NULL | Unique identifier for the user (UUIDv4 format) |
| `email` | TEXT | UNIQUE, NOT NULL, CHECK(length <= 254) | User's email address (normalized to lowercase, RFC 5322 compliant) |
| `password_hash` | TEXT | NOT NULL | Scrypt hash of user's password (format: `{salt_hex}:{key_hex}`) |
| `created_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Timestamp when user account was created (UTC) |
| `updated_at` | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP | Timestamp when user account was last modified (UTC) |

#### Validation Rules

Extracted from functional requirements (FR-004, FR-005, FR-006):

**Email (`email` field)**:
- **Required**: Must not be null or empty (FR-003)
- **Format**: RFC 5322 compliant email format (FR-004)
- **Max Length**: 254 characters (RFC 5321 standard) (FR-004, FR-004a)
- **Uniqueness**: Must be unique across all users (enforced by database UNIQUE constraint) (FR-007, FR-012)
- **Normalization**: Stored in lowercase for case-insensitive comparison (FR-015)
- **Validation Regex**: `/^[^\s@]+@[^\s@]+\.[^\s@]+$/` (simplified RFC 5322)

**Password (`password_hash` field)**:
- **Required**: Must not be null or empty (before hashing)
- **Min Length**: 8 characters (plaintext, before hashing) (FR-005, FR-006)
- **Max Length**: 128 characters (plaintext, before hashing) (FR-005, FR-006)
- **Hashing**: MUST be hashed using scrypt before storage (FR-008)
- **Storage**: NEVER store plaintext passwords (security requirement, SC-005)
- **Format**: Scrypt hash format `{16-byte-salt-hex}:{64-byte-key-hex}` (e.g., `a1b2c3...f0:d4e5f6...a0`)

**UUID (`id` field)**:
- **Format**: UUIDv4 (randomly generated) per assumption in spec
- **Generation**: Generated by application using `uuid` package (FR-010)
- **Storage**: Stored as TEXT in SQLite (UUID column type not supported)

**Timestamps (`created_at`, `updated_at` fields)**:
- **Auto-populated**: Set automatically during user creation (FR-014)
- **Format**: ISO 8601 timestamp (UTC)
- **`created_at`**: Set once at creation, never modified
- **`updated_at`**: Set at creation (future updates out of scope for this feature)

#### Indexes

```sql
CREATE UNIQUE INDEX idx_user_email ON user(email);
```

**Purpose**: 
- Enforces email uniqueness at database level (prevents race conditions)
- Improves performance of duplicate email checks during registration
- Used by duplicate detection query in user repository

#### Relationships

**None** - User entity is standalone for this feature. Future features may add relationships to other entities (e.g., user sessions, user profiles).

## Database Schema

### SQLite (Development)

```sql
CREATE TABLE IF NOT EXISTS user (
  id TEXT PRIMARY KEY NOT NULL,
  email TEXT UNIQUE NOT NULL CHECK(length(email) <= 254),
  password_hash TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_user_email ON user(email);
```

### PostgreSQL (Production - Migration Path)

```sql
CREATE TABLE IF NOT EXISTS "user" (
  id UUID PRIMARY KEY NOT NULL,
  email VARCHAR(254) UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX IF NOT EXISTS idx_user_email ON "user"(email);
```

**Notes**:
- PostgreSQL uses native UUID type (more efficient than TEXT)
- PostgreSQL uses VARCHAR(254) for email (enforces max length at database level)
- Table name `"user"` quoted (reserved keyword in PostgreSQL)

## TypeScript Types

### Domain Model (Type)

```typescript
/**
 * Represents a registered user in the system.
 */
export interface User {
  /** Unique identifier (UUIDv4 format) */
  id: string;
  
  /** User's email address (normalized to lowercase) */
  email: string;
  
  /** Scrypt hash of user's password (never exposed in responses) */
  passwordHash: string;
  
  /** Timestamp when user was created */
  createdAt: Date;
  
  /** Timestamp when user was last updated */
  updatedAt: Date;
}
```

### Database Row (Repository Layer)

```typescript
/**
 * Database row representation of user table.
 * Maps database column names (snake_case) to TypeScript.
 */
export interface UserRow {
  id: string;
  email: string;
  password_hash: string;
  created_at: string; // ISO 8601 string from database
  updated_at: string; // ISO 8601 string from database
}
```

### API DTOs (Request/Response)

```typescript
/**
 * Request body for POST /api/v1/users
 */
export interface CreateUserRequest {
  /** User's email address (max 254 characters) */
  email: string;
  
  /** User's password (8-128 characters, plaintext - will be hashed) */
  password: string;
}

/**
 * Response body for successful registration (HTTP 201)
 */
export interface CreateUserResponse {
  /** UUID of newly created user */
  id: string;
}

/**
 * Error response body for validation/conflict errors
 */
export interface ErrorResponse {
  error: {
    /** Unique request ID for tracing */
    requestId: string;
    
    /** Machine-readable error code */
    code: string;
    
    /** Human-readable error message */
    message: string;
    
    /** Field name that failed validation (optional) */
    field?: string;
  };
}
```

## State Transitions

User entity has minimal state for this feature (no status field).

**Creation Flow**:
```
[Non-existent] --[POST /api/v1/users with valid data]--> [Created]
```

**No state transitions** after creation in this feature. Future features (e.g., email verification, account deactivation) may introduce status field and state machine.

## Data Validation Summary

| Validation | Where Validated | Error Code | HTTP Status |
|------------|----------------|------------|-------------|
| Email required | Application (service layer) | `MISSING_EMAIL` | 400 |
| Email format (RFC 5322) | Application (service layer) | `INVALID_EMAIL_FORMAT` | 400 |
| Email max length (254) | Application (service layer) | `EMAIL_TOO_LONG` | 400 |
| Email uniqueness | Database (UNIQUE constraint) | `EMAIL_ALREADY_EXISTS` | 409 |
| Password required | Application (service layer) | `MISSING_PASSWORD` | 400 |
| Password min length (8) | Application (service layer) | `PASSWORD_TOO_SHORT` | 400 |
| Password max length (128) | Application (service layer) | `PASSWORD_TOO_LONG` | 400 |

**Validation Strategy**:
1. Application validates format and length (fail fast, clear error messages)
2. Database enforces uniqueness (atomic, prevents race conditions)
3. Service layer catches database constraint violations and maps to HTTP 409

## Security Considerations

1. **Password Storage**:
   - NEVER store plaintext passwords
   - ALWAYS hash with scrypt before storage
   - Scrypt parameters: SALT_LENGTH=16, KEY_LENGTH=64 (secure defaults)

2. **Email Normalization**:
   - Normalize to lowercase to prevent duplicate accounts with case variations
   - Trim whitespace before validation

3. **Password Length Limits**:
   - Min 8 characters: Reasonable security baseline
   - Max 128 characters: Prevents DoS via excessive hashing time

4. **Database Constraints**:
   - UNIQUE constraint on email prevents race conditions
   - Primary key on UUID ensures data integrity

## Data Volume Estimates

**Assumptions**:
- Average email: 25 characters
- Password hash: 160 characters (salt:key hex format)
- UUID: 36 characters
- Timestamps: 25 characters each (ISO 8601)

**Per User**:
- id: 36 bytes
- email: ~25 bytes (average)
- password_hash: 160 bytes
- created_at: 25 bytes
- updated_at: 25 bytes
- **Total per user**: ~271 bytes

**Scale Estimates**:
- 1,000 users: ~271 KB
- 10,000 users: ~2.71 MB
- 100,000 users: ~27.1 MB
- 1,000,000 users: ~271 MB

**Note**: These are conservative estimates. Actual database storage includes indexes, metadata, and overhead. Performance is not a concern per Principle XIV.

## Future Enhancements (Out of Scope)

The following are explicitly out of scope for this feature but may be added in future:

1. **Email Verification**:
   - Add `email_verified` boolean field
   - Add `verification_token` field
   - State transition: [Created, Unverified] â†’ [Verified]

2. **Account Status**:
   - Add `status` enum field (ACTIVE, SUSPENDED, DELETED)
   - Soft delete support

3. **User Profile**:
   - Separate `user_profile` table with additional fields
   - Foreign key relationship to `user` table

4. **Password History**:
   - Prevent password reuse
   - Separate `password_history` table

5. **Last Login Tracking**:
   - Add `last_login_at` timestamp

6. **Failed Login Attempts**:
   - Add `failed_login_count`, `locked_until` fields
   - Account lockout after N failures

7. **Two-Factor Authentication**:
   - Add `totp_secret` field
   - State transitions for 2FA enrollment

---

## References

- Feature Specification: [spec.md](./spec.md)
- Research Document: [research.md](./research.md)
- Implementation Plan: [plan.md](./plan.md)

