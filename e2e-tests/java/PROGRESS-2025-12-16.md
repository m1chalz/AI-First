# Progress Report: iOS Location Dialog Tests (Dec 16, 2025)

## ‚úÖ Implemented Features

### 1. @locationDialog Tag System
- **Location**: `AppiumDriverManager.java`, `Hooks.java`
- **Purpose**: Controls whether iOS location permission dialogs are shown or auto-granted
- **Usage**: 
  ```gherkin
  @locationDialog
  Scenario: User sees location permission popup
  ```
- **Behavior**:
  - WITH tag: Real system dialog appears, permissions NOT auto-granted
  - WITHOUT tag: Permissions granted silently via `simctl` or `appium:permissions`

### 2. Auto-Build Mobile Apps
- **Location**: `AppBuilder.java`, `Hooks.java`
- **Features**:
  - Parallel build (iOS + Android using `CompletableFuture`)
  - Automatic uninstall before build
  - Copy to `e2e-tests/java/apps/`
  - Skip with: `-Dskip.app.build=true`
- **Build Paths**:
  - iOS: `iosApp/build/Build/Products/Debug-iphonesimulator/iosApp.app`
  - Android: `composeApp/build/outputs/apk/debug/composeApp-debug.apk`

### 3. Debug Screenshots with Timestamp
- **Location**: `DebugScreenshotHelper.java`
- **Enable**: `-Ddebug.screenshots=true`
- **Format**: `[counter]_[YYYYMMDD-HHmmss-SSS]_[action_name].png`
- **Example**: `001_20251216-152304-567_tap_first_pet.png`
- **Output**: `target/debug-screenshots/`

### 4. App Reinstall (Separate Phases)
- **Location**: `AppiumDriverManager.java`
- **Methods**:
  - `uninstallApp()` - Removes app from device/simulator
  - `installApp()` - Installs app from `apps/` directory
  - `reinstallApp()` - Calls both + resets location permissions if `@locationDialog`
- **iOS Permission Reset**: 
  - Calls `simctl privacy reset location` before uninstall
  - Only when `showLocationDialog.get() == true`

### 5. iOS 18.1 getPageSource() Fix
- **Issue**: `getPageSource()` crashes on iOS 18.1 with XCUITest
- **Solution**: Replace with `driver.findElements(By.xpath(...))` for element checks
- **Location**: All instances in `PetListMobileSteps.java`

---

## ‚ùå Current Blocker: Network Connection Issue

### Symptoms
```
java.net.ConnectException: Operation not permitted
    at java.base/sun.nio.ch.Net.connect0(Native Method)
```

### What Works
- ‚úÖ Appium server starts successfully (manual: `appium`)
- ‚úÖ Appium listening on `http://127.0.0.1:4723`
- ‚úÖ `lsof -ti:4723` confirms Appium running
- ‚úÖ `curl http://127.0.0.1:4723/status` returns valid response
- ‚úÖ Tag detection: `@locationDialog tag detected - will show real location permission popup`
- ‚úÖ iOS config: `autoAcceptAlerts: false` when `@locationDialog` present

### What Fails
- ‚ùå Maven/Java cannot connect to Appium (socket connection blocked)
- ‚ùå Error occurs during `IOSDriver` constructor (creating session)

### Previous Attempts
1. **Tried**: Maven Surefire config (`useSystemClassLoader`, `useManifestOnlyJar`)
   - **Result**: No change
2. **Tried**: `-Djava.net.preferIPv4Stack=true`
   - **Result**: No change
3. **Tried**: Appium bind to `--address 127.0.0.1` instead of `0.0.0.0`
   - **Result**: No change
4. **Tried**: Appium with project-local `APPIUM_HOME=target/.appium`
   - **Result**: Failed - no drivers installed in `target/.appium`

### Hypotheses
1. **macOS Firewall/Security**: Java process blocked from network access
2. **Cursor Terminal Sandbox**: Terminal launched by Cursor has restricted permissions
3. **JDK 23 Security**: New security restrictions in Java 23

---

## üîß Next Steps (After macOS Restart) - UPDATED

### ‚úÖ ROOT CAUSE IDENTIFIED (Dec 16, 2025 - After Restart)

**Problem**: Cursor terminal sandbox blocks BOTH:
1. Appium write access to `~/.appium` (EPERM)
2. Maven network connections to `localhost:4723` (ConnectException)

**Solution**: Run EVERYTHING from **external terminal** (iTerm/Terminal.app), NOT from Cursor!

### Step 1: Run Appium from External Terminal
```bash
# Terminal 1 (iTerm/Terminal.app)
appium --address 127.0.0.1

# Verify it started (Terminal 2)
curl http://127.0.0.1:4723/status
```

### Step 2: Run Tests from External Terminal
```bash
# Terminal 2 (iTerm/Terminal.app) - NOT Cursor terminal!
cd /Users/szymon.wagner/projects/INTIVE/AI-First/e2e-tests/java

mvn test -Dtest=IosTestRunner \
  -DPLATFORM=iOS \
  -Dcucumber.filter.tags="@locationDialog" \
  -Dskip.app.build=true \
  -Ddebug.screenshots=true
```

### Alternative: Verify macOS Firewall (If Still Issues)
```bash
# Check if Java is blocked by firewall (unlikely after using external terminal)
sudo /usr/libexec/ApplicationFirewall/socketfilterfw --list
```

**Note**: Project-local APPIUM_HOME is NOT needed since external terminal has full access to `~/.appium`

---

## üìÅ Modified Files

### Core Implementation
- `e2e-tests/java/src/test/java/com/intive/aifirst/petspot/e2e/utils/AppiumDriverManager.java`
  - Added `showLocationDialog` ThreadLocal flag
  - Added `setShowLocationDialog()` static method
  - Modified `createIOSDriver()` to conditionally set permissions
  - Added `resetIOSLocationPermission()` for iOS permission reset
  - Modified `reinstallApp()` to reset permissions before uninstall
  - Disabled auto-start (manual Appium required)
  - Disabled `isAppiumRunning()` check (Maven sandbox blocks socket connection)

- `e2e-tests/java/src/test/java/com/intive/aifirst/petspot/e2e/utils/Hooks.java`
  - Added `detectLocationDialogTag()` method
  - Calls `AppiumDriverManager.setShowLocationDialog()` based on tag

- `e2e-tests/java/src/test/java/com/intive/aifirst/petspot/e2e/utils/AppBuilder.java`
  - New class for auto-building mobile apps
  - Parallel build support (iOS + Android)
  - Uninstall, build, copy workflow

- `e2e-tests/java/src/test/java/com/intive/aifirst/petspot/e2e/utils/DebugScreenshotHelper.java`
  - New class for debug screenshots
  - Timestamped filenames with counter
  - Optional feature via system property

### Step Definitions
- `e2e-tests/java/src/test/java/com/intive/aifirst/petspot/e2e/steps/mobile/PetListMobileSteps.java`
  - Fixed iOS 18.1 incompatibility (replaced `getPageSource()` with `findElements()`)
  - Added `I uninstall the app` step
  - Added `I install the app` step

### Feature Files
- `e2e-tests/java/src/test/resources/features/animal-list.feature`
  - Added `@locationDialog` tag to "User reinstalls app and sees rationale dialog on fresh launch"
  - Changed restart to uninstall/install flow

### Configuration
- `e2e-tests/java/pom.xml`
  - Added `useSystemClassLoader` and `useManifestOnlyJar` (attempted fix)
  - Added `-Djava.net.preferIPv4Stack=true` (attempted fix)

### iOS App
- `iosApp/iosApp/Configuration/APIConfig.swift`
  - Changed `baseURL` from `localhost` to `127.0.0.1` (iOS simulator fix)

### Documentation
- `e2e-tests/README.md`
  - Added "Current Development Status" section
  - Added "Known Issues" section
  - Added debug screenshots documentation

---

## üéØ Test Scenarios Ready to Run

Once network issue is resolved:

### Test 1: Basic scenario (no @locationDialog)
```bash
mvn test -Dtest=IosTestRunner -DPLATFORM=iOS \
  -Dcucumber.filter.tags="@mobile and @ios and not @locationDialog" \
  -Dskip.app.build=true
```

### Test 2: Location dialog scenario (@locationDialog)
```bash
mvn test -Dtest=IosTestRunner -DPLATFORM=iOS \
  -Dcucumber.filter.tags="@locationDialog" \
  -Dskip.app.build=true \
  -Ddebug.screenshots=true
```

Expected behavior:
1. App launches fresh (uninstall + install)
2. Location rationale dialog appears (real iOS system popup)
3. Test can interact with Cancel/Settings buttons
4. Screenshots captured before each action

---

## üìù Notes

- Tests **DID work previously** - this is a regression, not an architectural issue
- macOS restart may resolve if it's a temporary security/firewall state
- External terminal may have different sandbox/security context than Cursor terminal
- If all else fails, project-local Appium with installed drivers is the fallback


